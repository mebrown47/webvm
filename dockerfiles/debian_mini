# Replace dockerfiles/debian_mini with this content
# RTL-SDR customized WebVM image

FROM --platform=i386 i386/debian:bookworm
ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get -y upgrade && apt-get -y install \
        apt-utils \
        curl \
        wget \
        gpg \
        lsb-release \
        ca-certificates \
        gnupg \
        vim \
        nano \
        sudo \
        procps \
        htop \
        net-tools \
        dnsutils \
        # Build dependencies for Python packages
        build-essential \
        python3-dev \
        libffi-dev \
        libssl-dev \
        pkg-config \
        # RTL-SDR specific packages
        rtl-sdr \
        librtlsdr-dev \
        gnuradio \
        gnuradio-dev \
        gqrx-sdr \
        multimon-ng \
        dump1090-mutability \
        sox \
        python3-pip \
        python3-numpy \
        python3-scipy \
        python3-matplotlib \
        # Use Debian packages instead of pip where possible
        python3-pyrtlsdr

# Add user and setup
RUN useradd -m user && echo "user:password" | chpasswd && adduser user sudo
WORKDIR /home/user/

# Create RTL-SDR welcome script
RUN echo '#!/bin/bash' > /usr/local/bin/sdr-welcome && \
    echo 'echo "=== RTL-SDR WebVM Environment ==="' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "Available SDR tools:"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "  rtl_test     - Test your RTL-SDR dongle"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "  rtl_fm       - FM demodulator"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "  rtl_power    - Power spectrum analyzer"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "  dump1090     - ADS-B decoder for aircraft"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "  gqrx         - GUI spectrum analyzer"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo ""' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "ðŸ”Œ Connect RTL-SDR dongle and grant browser USB access"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo "ðŸ§ª Try: rtl_test -t  (test dongle)"' >> /usr/local/bin/sdr-welcome && \
    echo 'echo ""' >> /usr/local/bin/sdr-welcome && \
    chmod +x /usr/local/bin/sdr-welcome

# Add to bashrc so it shows on login
RUN echo 'sdr-welcome' >> /home/user/.bashrc

# Environment setup 
ENV HOME="/home/user" TERM="xterm" USER="user" SHELL="/bin/bash" EDITOR="vim" LANG="en_US.UTF-8" LC_ALL="C"
RUN echo 'root:password' | chpasswd

CMD [ "/bin/bash" ]
