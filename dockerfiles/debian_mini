# Stage A: Build Node assets on runnerarch (amd64)
FROM node:20-bullseye AS node-build
WORKDIR /src
COPY package.json package-lock.json* ./
RUN npm ci --no-audit --no-fund
COPY . .
RUN npm run build

# Stage B: i386 runtime for WebVM (minimal SDR runtime)
FROM --platform=linux/386 i386/debian:bookworm-slim
ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates wget curl gnupg lsb-release \
    python3 python3-pip python3-pyrtlsdr rtl-sdr librtlsdr-dev sox \
    && rm -rf /var/lib/apt/lists/*

# copy built web assets from amd64 stage
WORKDIR /app
COPY --from=node-build /src/dist ./dist   # adjust to your build output dir
COPY --from=node-build /src/package.json ./package.json
# copy any runtime server or entrypoint as needed

CMD ["/bin/bash"]
